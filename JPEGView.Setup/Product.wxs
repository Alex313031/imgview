<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

	<!-- modeled after the very helpful post: https://helgeklein.com/blog/real-world-example-wix-msi-application-installer/ -->

	<!--
      ====================================================================================
      Defines & Variables
	-->

	<!-- Full version number to display -->
	<?define VersionNumber="!(bind.FileVersion.JPEGView.exe)" ?>

	<!--
	Upgrade code HAS to be the same for all updates.
	Once you've chosen it don't change it.
	-->
	<?define UpgradeCode="cc010056-8703-4ec9-a56e-7cb52641d6f4" ?>


	<!-- The URL for add/remove programs -->
	<?define InfoURL="https://github.com/sylikc/jpegview" ?>

	<!-- 32-bit / 64-bit variables -->
	<?if $(var.Platform) = x64 ?>
		<?define Win64 = "yes" ?>
		<?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
		<?define JPEGViewExeSourcePath = "$(var.JPEGView.ProjectDir)\x64\Release\JPEGView.exe" ?>
	<?else ?>
		<?define Win64 = "no" ?>
		<?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
		<?define JPEGViewExeSourcePath = "$(var.JPEGView.ProjectDir)\x86\Release\JPEGView.exe" ?>
	<?endif ?>

	<!--
      ====================================================================================
      Package start
   -->


	<!-- The upgrade code must never change as long as the product lives! -->
	<!-- Product IDs must be autogenerated (*) or else major upgrades will not work -->
	<Product Id="*" Name="!(loc.ApplicationName)" Language="!(loc.Language)" Version="$(var.VersionNumber)" Manufacturer="!(loc.ManufacturerFullName)" UpgradeCode="$(var.UpgradeCode)">

		<!-- Package IDs are valid for a single package version only - they are autogenerated by WiX -->
		<!-- And ALWAYS install per machine!!! -->
		<Package Id="*" InstallerVersion="200" Compressed="yes" InstallScope="perMachine" Description="!(loc.ProductDescription)" Comments="!(loc.Comments) $(var.VersionNumber)" />

		<!-- https://wixtoolset.org//documentation/manual/v3/wixui/wixui_dialog_library.html -->
		<!-- adding a UI needs a new reference manually added - https://stackoverflow.com/questions/596919/how-to-add-a-ui-to-a-wix-3-installer -->
		<UIRef Id="WixUI_Advanced" />
		<Property Id="ApplicationFolderName" Value="!(loc.ApplicationName)" />
		<Property Id="WixAppFolder" Value="WixPerMachineFolder" />

		<!-- License agreement text: dummy. Real text is set in WXS file -->
		<!-- <WixVariable Id="WixUILicenseRtf" Value="dummy" /> -->

		<!-- UI customization -->
		<!--
		<WixVariable Id="WixUIBannerBmp" Value="images\BannerTop.bmp" />
		<WixVariable Id="WixUIDialogBmp" Value="images\Dialog.bmp" />
		-->

		<!-- Define icons (ID should not be longer than 18 chars and must end with ".exe") -->
		<Icon Id="Icon.exe" SourceFile="$(var.JPEGView.ProjectDir)\res\JPEGView.ico" />

		<!-- Set properties for add/remove programs -->
		<Property Id="ARPPRODUCTICON" Value="Icon.exe" />
		<Property Id="ARPHELPLINK" Value="$(var.InfoURL)" />
		<Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />			<!-- Remove repair -->
		<Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />			<!-- Remove modify -->

		<!-- Upgrade logic -->
		<!-- AllowSameVersionUpgrades -> Always upgrade, never allow two versions to be installed next to each other -->
		<!-- AllowSameVersionUpgrades causes ICE61 which must be ignored -->
		<MajorUpgrade DowngradeErrorMessage="!(loc.NewerInstalled)" AllowSameVersionUpgrades="yes" />





		<!-- This is the main installer sequence run when the product is actually installed -->
		<InstallExecuteSequence>
			<!-- Determine the install location after the install path has been validated by the installer -->
			<Custom Action="SetARPINSTALLLOCATION" After="InstallValidate"></Custom>
		</InstallExecuteSequence>

		<!-- Set up ARPINSTALLLOCATION property (http://blogs.technet.com/b/alexshev/archive/2008/02/09/from-msi-to-wix-part-2.aspx) -->
		<CustomAction Id="SetARPINSTALLLOCATION" Property="ARPINSTALLLOCATION" Value="[INSTALLDIR]" />

		<!--
         Launch conditions

         1. Check minimum OS version
            If not, the installation is aborted.
            By doing the (Installed OR ...) property means that this condition will only be evaluated if the app is being installed and not on uninstall or changing

            Note: Under a Product element, a condition becomes a LaunchCondition entry.
		-->
		<!--
		<Condition Message="!(loc.OS2Old)">
			<![CDATA[Installed OR (VersionNT >= 600)]]>
		</Condition>
		-->

		<!--
         2. Check OS bitness
            Unfortunately 32-bit MSI packages cannot write to 64-bit ProgramFiles directory. That is the only reason we need separate MSIs for 32-bit and 64-bit.
		-->
		<?if $(var.Platform) = x64 ?>
			<Condition Message="!(loc.x86VersionRequired)">
				<![CDATA[VersionNT64]]>
			</Condition>
		<?endif?>

		<?if $(var.Platform) = x86 ?>
			<Condition Message="!(loc.x64VersionRequired)">
				<![CDATA[NOT VersionNT64]]>
			</Condition>
		<?endif?>
		<!--
			Launch conditions end
		-->



		<!-- Save the command line value INSTALLDIR and restore it later in the sequence or it will be overwritten by the value saved to the registry during an upgrade -->
		<!-- http://robmensching.com/blog/posts/2010/5/2/the-wix-toolsets-remember-property-pattern/ -->
		<CustomAction Id='SaveCmdLineValueINSTALLDIR' Property='CMDLINE_INSTALLDIR' Value='[INSTALLDIR]' Execute='firstSequence' />
		<CustomAction Id='SetFromCmdLineValueINSTALLDIR' Property='INSTALLDIR' Value='[CMDLINE_INSTALLDIR]' Execute='firstSequence' />
		<InstallUISequence>
			<Custom Action='SaveCmdLineValueINSTALLDIR' Before='AppSearch' />
			<Custom Action='SetFromCmdLineValueINSTALLDIR' After='AppSearch'>
				CMDLINE_INSTALLDIR
			</Custom>
		</InstallUISequence>
		<InstallExecuteSequence>
			<Custom Action='SaveCmdLineValueINSTALLDIR' Before='AppSearch' />
			<Custom Action='SetFromCmdLineValueINSTALLDIR' After='AppSearch'>
				CMDLINE_INSTALLDIR
			</Custom>
		</InstallExecuteSequence>



		<!-- Determine the directory of a previous installation (if one exists). If not INSTALLDIR stays empty -->
		<!--
		<Property Id="INSTALLDIR">
			<RegistrySearch Id="DetermineInstallLocation" Type="raw" Root="HKLM" Key="Software\!(loc.ManufacturerName)\InstalledProducts\!(loc.ApplicationName)" Name="InstallLocation" />
		</Property>
		-->


		<!--
			====================================================================================
			Start to build directory structure
		-->

		<MediaTemplate EmbedCab="yes" /><!-- if you don't set EmbedCab, it outputs a MSI + CAB file-->

		<Feature Id="ProductFeature" Title="JPEGView" Level="1">
			<!-- <ComponentGroupRef Id="ProductComponents" /> -->
			<ComponentRef Id="JPEGViewExe"/>
			<ComponentRef Id="INSTALLDIR_comp"/>
			<Feature Id="FeatureWebP" Title="WebP Support">
				<ComponentRef Id="webpDLL"/>
			</Feature>
			<Feature Id="FeatureWIC" Title="WIC Support">
				<ComponentRef Id="WICLoaderDLL"/>
			</Feature>
		</Feature>
	</Product>

	<Fragment>
		<!-- Outermost folder (kind of virtual). Fixed entry. -->
		<Directory Id="TARGETDIR" Name="SourceDir">
			<!-- We start building our directory structure here -->
			<!-- "ProgramFilesFolder" is a variable containing the absolute path. -->
			<!-- For a list of folder variables, see: http://msdn.microsoft.com/en-us/library/aa372057%28VS.85%29.aspx -->
			<Directory Id="$(var.PlatformProgramFilesFolder)">

				<!-- All folders from here on are relative to their parent. -->
				<Directory Id="INSTALLDIR" Name="!(loc.ApplicationName)">

					<!-- Define components, the building blocks of MSIs. -->
					<!-- Rule: A component should only contain items that belong together so strongly that they always need to be installed or removed together. -->
					<!-- If this means a single file, then your components will contain a single file each. This is not only normal but exactly what you're -->
					<!-- to do. Don't be afraid, Windows Installer can efficiently handle thousands of components or more, if needed. -->

					<!-- Installation directory as a component so it can be emptied during uninstall (by default files added by someone other than Windows Installer are not removed) -->
					<Component Id="INSTALLDIR_comp" Guid="42282a63-0b30-4a28-bb30-8b668740f6a4">
						<CreateFolder />
						<RemoveFile Id="RemoveFilesFromAppDirectory" Name="*.*" On="uninstall" />
					</Component>


					<!-- Main program file -->
					<!--
					<Component Id="JPEGView.exe_comp" Guid="*" Win64="$(var.Win64)">
						<File Source="$(var.JPEGViewExeSourcePath)" Id="JPEGViewExe" KeyPath="yes" />
					</Component>
					-->

					<!-- Configuration file -->
					<!--
					<Component Id="uberAgent.conf_comp" Guid="YOUR-GUID-HERE">
						<File Source="$(var.ProjectDir)..\uberAgent\Config file\Standalone mode\uberAgent.conf" Id="uberAgentConf" KeyPath="yes" />
					</Component>
					-->


					<Component Id="JPEGViewExe" Guid="30be6f3f-71ea-4829-82bd-2b3ddb846079">
						<File Id="JPEGView.exe" Name="JPEGView.exe" Source="$(var.JPEGView.TargetDir)JPEGView.exe" />
					</Component>
					<Component Id="webpDLL" Guid="43e917db-b269-40bf-81ab-b2d1453b225f">
						<File Id="webp.dll" Name="webp.dll" Source="$(var.WEBP.TargetDir)webp.dll" />
					</Component>
					<Component Id="WICLoaderDLL" Guid="742ca948-b7d3-4ca4-9aab-2592616416ed">
						<File Id="WICLoader.dll" Name="WICLoader.dll" Source="$(var.WICLoader.TargetDir)WICLoader.dll" />
					</Component>

				</Directory>
			</Directory>
		</Directory>
	</Fragment>

	<!--
	<Fragment>
		<ComponentGroup Id="ProductComponents" Directory="INSTALLDIR">
				<Component Id="JPEGViewExe" Guid="30be6f3f-71ea-4829-82bd-2b3ddb846079">
					<File Id="JPEGView.exe" Name="JPEGView.exe" Source="$(var.JPEGView.TargetDir)JPEGView.exe" />
				</Component>
				<Component Id="webpDll" Guid="43e917db-b269-40bf-81ab-b2d1453b225f">
					<File Id="webp.dll" Name="webp.dll" Source="$(var.WEBP.TargetDir)webp.dll" />
				</Component>
				<Component Id="WICLoaderDll" Guid="742ca948-b7d3-4ca4-9aab-2592616416ed">
					<File Id="WICLoader.dll" Name="WICLoader.dll" Source="$(var.WICLoader.TargetDir)WICLoader.dll" />
				</Component>
		</ComponentGroup>
	</Fragment>
	-->

</Wix>
